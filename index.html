<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subham Fancy Store</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="https://raw.githubusercontent.com/subooom/subham-fancy-store-mgmt/refs/heads/main/favicon.ico"
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .form-section {
        display: none;
      }
      .form-section.active {
        display: block;
      }
      .nav-tab.active {
        background-color: #dc2626; /* red-600 */
      }
      .sales-tab.active,
      .expenses-tab.active,
      .loans-tab.active,
      .dues-tab.active {
        background-color: oklch(51.1% 0.262 276.966); /* indigo-600 */
        color: white;
      }
      .expenses-content,
      .loans-content,
      .dues-content {
        display: none;
      }
      .expenses-content.active,
      .loans-content.active,
      .dues-content.active {
        display: block;
      }
      .period-btn.active,
      .expenses-period-btn.active,
      .loans-period-btn.active,
      .dues-period-btn.active {
        background-color: oklch(58.5% 0.233 277.117); /* indigo-500 */
        color: white;
      }
      .period-btn.active:hover,
      .expenses-period-btn.active:hover,
      .loans-period-btn.active:hover,
      .dues-period-btn.active:hover {
        background-color: oklch(51.1% 0.262 276.966); /* indigo-600 */
      }
      .message.success {
        color: oklch(62.7% 0.194 149.214); /* green-600 */
      }
      .message.error {
        color: #e30004; /* red-600 */
      }
      .date-nav-btn {
        background-color: #e5e7eb; /* gray-200 */
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
      }
      .date-nav-btn:hover {
        background-color: #d1d5db; /* gray-300 */
      }
      .submit-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }
    </style>
  </head>
  <body
    class="relative min-h-screen bg-gradient-to-br text-xl from-indigo-400 to-purple-600 p-5 font-sans"
  >
    <div
      id="spinnerDiv"
      class="fixed inset-0 bg-black/30 z-20 max-h-screen mx-auto rounded-2xl hidden"
    >
      <svg
        class="mr-3 -ml-1 size-5 md:size-10 lg:size-14 animate-spin text-indigo-100"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
    </div>
    <div
      class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden"
    >
      <div
        class="bg-gray-900 text-white px-8 py-5 flex items-center justify-between shadow-lg"
      >
        <!-- Left Section -->
        <div>
          <h1
            class="text-2xl font-semibold tracking-wide"
            data-i18n="business.name"
          >
            Subham Fancy Store
          </h1>
          <p class="text-sm text-gray-400" data-i18n="page.description">
            Business Management System
          </p>
        </div>

        <!-- Right Section -->
        <div
          class="flex items-center flex-wrap justify-center md:justify-start md:flex-nowrap gap-4"
        >
          <!-- Vault / Galla Display -->
          <div
            id="vault-amount"
            class="bg-gray-800 px-5 py-2 rounded-xl text-sm font-medium border border-gray-700"
          >
            <span data-i18n="vault">Galla</span>:
            <span data-i18n="currency">₹</span><span id="vaultAmount">0</span>
          </div>

          <!-- Locale Selector -->
          <select
            id="locale-select"
            class="bg-gray-800 border border-gray-700 text-sm text-white rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 transition"
          >
            <option value="en" selected>🇬🇧 English</option>
            <option value="ne">🇳🇵 नेपाली</option>
          </select>
        </div>
      </div>

      <div class="flex bg-gray-700">
        <button
          class="nav-tab flex-1 p-3 text-white hover:not-active:bg-gray-600"
          data-i18n="navbar.sales"
          onclick="showTab(event, 'sale')"
        >
          Sales
        </button>
        <button
          class="nav-tab flex-1 p-3 text-white hover:not-active:bg-gray-600"
          data-i18n="navbar.expenses"
          onclick="showTab(event, 'expense')"
        >
          Expenses
        </button>
        <button
          class="nav-tab flex-1 p-3 text-white hover:not-active:bg-gray-600"
          data-i18n="navbar.loans"
          onclick="showTab(event, 'loan')"
        >
          Loans
        </button>
        <button
          class="nav-tab flex-1 p-3 text-white hover:not-active:bg-gray-600"
          data-i18n="navbar.dues"
          onclick="showTab(event, 'due')"
        >
          Dues
        </button>
        <button
          class="nav-tab flex-1 p-3 text-white hover:not-active:bg-gray-600"
          data-i18n="navbar.dashboard"
          onclick="showTab(event, 'dashboard')"
        >
          Dashboard
        </button>
      </div>

      <!-- Forms Container -->
      <div class="p-6">
        <!-- Sales -->
        <div id="sale-form" class="form-section active">
          <h2 class="text-xl font-bold mb-4" data-i18n="tabs.sales.title">
            Sales Management
          </h2>
          <div
            id="dailySnapshot"
            class="bg-gradient-to-r mb-4 from-indigo-200 via-purple-200 to-pink-200 text-black rounded-2xl shadow-2xl p-6 mt-6 transition-all duration-500 hover:scale-[1.02]"
          >
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-semibold" data-i18n="sales.todaySnapshot">
                Today's Snapshot
              </h2>
              <span id="snapshotDate" class="text-sm opacity-80"></span>
            </div>

            <div class="grid grid-cols-3 gap-4 text-center">
              <div>
                <p class="text-2xl font-bold" id="salesAmount">₹0</p>
                <p class="text-sm opacity-90" data-i18n="sales.totalSales">
                  Sales
                </p>
              </div>
              <div>
                <p class="text-2xl font-bold" id="profitAmount">₹0</p>
                <p class="text-sm opacity-90" data-i18n="sales.totalProfit">
                  Profit
                </p>
              </div>
              <div>
                <p class="text-2xl font-bold" id="itemsSold">0</p>
                <p class="text-sm opacity-90" data-i18n="sales.itemsSold">
                  Items Sold
                </p>
              </div>
            </div>

            <div
              id="motivationMsg"
              class="text-center mt-4 text-sm font-medium opacity-90 italic"
            >
              <span data-i18n="sales.motivation.start"
                >Start logging to see your progress!</span
              >
            </div>
          </div>

          <!-- Sales Tabs -->
          <div class="flex mb-4 bg-gray-100 rounded-lg overflow-hidden">
            <button
              class="sales-tab flex-1 p-3 text-gray-700 active hover:not-active:bg-gray-200 active:bg-indigo-600 active:text-white"
              onclick="showSalesTab(event, 'add-sale')"
              data-i18n="tabs.sales.add_sale"
            >
              Add Sale
            </button>
            <button
              class="sales-tab flex-1 p-3 text-gray-700 hover:not-active:bg-gray-200"
              onclick="showSalesTab(event, 'view-sales')"
              data-i18n="tabs.sales.view_sale"
            >
              View Sales
            </button>
          </div>
          <!-- Add Sale Form -->
          <div id="add-sale" class="sales-content active">
            <h3
              class="text-lg font-semibold mb-3"
              data-i18n="tabs.sales.add_new_sale"
            >
              Add New Sale
            </h3>
            <form id="saleForm" class="space-y-4">
              <div>
                <label
                  for="productName"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.sales.form.product_name"
                  >Product Name</label
                >
                <input
                  id="productName"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500 focus:outline-none"
                />
              </div>

              <div class="max-w-sm">
                <label
                  for="quantity"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.sales.form.quantity"
                  >Quantity</label
                >
                <input
                  type="number"
                  id="quantity"
                  value="1"
                  min="1"
                  step="1"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500 focus:outline-none"
                />
              </div>

              <div class="grid grid-cols-1 gap-4">
                <div>
                  <label
                    for="costPrice"
                    class="block font-semibold text-gray-700 mb-1"
                    data-i18n="tabs.sales.form.cost_price"
                    >Cost Price (₹)</label
                  >
                  <input
                    type="number"
                    id="costPrice"
                    step="0.01"
                    required
                    class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500 focus:outline-none"
                  />
                </div>
                <div>
                  <div class="flex gap-2 mb-1">
                    <label
                      for="sellingPrice"
                      class="block font-semibold text-gray-700"
                      data-i18n="tabs.sales.form.selling_price"
                      >Selling Price (₹)
                    </label>
                    <span
                      id="instantProfitBadge"
                      class="hidden text-sm font-semibold px-2 py-0 flex items-center justify-center rounded-full bg-green-200 text-green-800 transition-all duration-200"
                    >
                      +₹0
                    </span>
                  </div>
                  <input
                    type="number"
                    id="sellingPrice"
                    step="0.01"
                    required
                    class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500 focus:outline-none"
                  />
                </div>
              </div>

              <div>
                <label
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.sales.form.payment_method"
                  >Payment Method</label
                >

                <!-- Single Payment Method -->
                <div id="single-payment-section">
                  <select
                    id="paymentMethod"
                    value="handcash"
                    class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500 focus:outline-none"
                  >
                    <option
                      value=""
                      data-i18n="tabs.sales.form.select_payment_method"
                    >
                      Select Payment Method
                    </option>
                    <!-- Payment methods will be populated by JavaScript -->
                  </select>
                </div>

                <!-- Split Payment Toggle -->
                <div class="mt-2">
                  <label class="inline-flex items-center">
                    <input
                      type="checkbox"
                      id="splitPaymentToggle"
                      class="rounded border-gray-300 text-red-600 focus:ring-red-500"
                    />
                    <span
                      class="ml-2 text-sm text-gray-600"
                      data-i18n="tabs.sales.form.split_payment"
                      >Split Payment</span
                    >
                  </label>
                </div>

                <!-- Split Payment Methods -->
                <div
                  id="split-payment-section"
                  class="hidden mt-3 space-y-3 p-3 bg-gray-50 rounded-lg border border-gray-200"
                >
                  <div id="split-payment-methods">
                    <!-- Split payment rows will be added here -->
                  </div>

                  <div class="flex justify-between items-center">
                    <span
                      class="text-sm font-medium text-gray-700"
                      data-i18n="tabs.sales.form.total_payment"
                      >Total Payment:</span
                    >
                    <span
                      id="split-payment-total"
                      class="text-sm font-bold text-gray-900"
                      >₹0.00</span
                    >
                  </div>

                  <div
                    id="split-payment-error"
                    class="text-sm text-red-600 hidden"
                    data-i18n="tabs.sales.form.total_payment_mismatch"
                  >
                    Total payment does not match selling price
                  </div>

                  <button
                    type="button"
                    id="add-payment-method"
                    class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg text-sm"
                    data-i18n="tabs.sales.form.add_payment_method"
                  >
                    Add Payment Method
                  </button>
                </div>
              </div>

              <div>
                <label
                  for="saleDate"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.sales.form.sale_date"
                  >Sale Date</label
                >
                <input
                  type="date"
                  id="saleDate"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500 focus:outline-none"
                />
              </div>

              <div>
                <label
                  for="saleNotes"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.sales.form.notes"
                  >Notes (Optional)</label
                >
                <textarea
                  id="saleNotes"
                  rows="2"
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500 focus:outline-none"
                ></textarea>
              </div>

              <!-- Calculation Summary -->
              <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                <h4
                  class="font-semibold text-indigo-800 mb-2"
                  data-i18n="tabs.sales.form.calculation_summary"
                >
                  Calculation Summary
                </h4>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div>
                    <span data-i18n="tabs.sales.form.total_cost"
                      >Total Cost:</span
                    >
                    <span id="total-cost-display" class="font-medium"
                      >₹0.00</span
                    >
                  </div>
                  <div>
                    <span data-i18n="tabs.sales.form.total_selling"
                      >Total Selling:</span
                    >
                    <span id="total-selling-display" class="font-medium"
                      >₹0.00</span
                    >
                  </div>
                  <div class="col-span-2">
                    <span data-i18n="tabs.sales.form.total_profit"
                      >Total Profit:</span
                    >
                    <span
                      id="total-profit-display"
                      class="font-medium text-green-600"
                      >₹0.00</span
                    >
                  </div>
                </div>
              </div>

              <button
                type="submit"
                class="submit-btn w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg"
                data-i18n="tabs.sales.form.submit"
              >
                Add Sale
              </button>
            </form>
            <div
              id="sale-message"
              class="mt-3 text-center font-semibold hidden"
            ></div>
          </div>

          <!-- View Sales -->
          <div id="view-sales" class="sales-content hidden">
            <div class="flex flex-wrap justify-between items-center mb-4">
              <div class="flex gap-2 items-center">
                <div id="spinnerInsert"></div>

                <h3
                  class="text-lg font-semibold"
                  data-i18n="tabs.sales.sales_view"
                >
                  Sales View
                </h3>
              </div>
              <div class="flex items-center space-x-2">
                <button
                  class="date-nav-btn"
                  onclick="changeDate(-1)"
                  data-i18n="tabs.sales.previous"
                >
                  ← Previous
                </button>
                <span
                  id="selected-date"
                  class="font-medium px-3 py-1 bg-indigo-100 rounded-lg"
                ></span>
                <button
                  class="date-nav-btn"
                  onclick="changeDate(1)"
                  data-i18n="tabs.sales.next"
                >
                  Next →
                </button>
              </div>
            </div>

            <!-- Period Filter Buttons -->
            <div class="flex mb-4">
              <div
                class="inline-flex rounded-lg overflow-hidden border border-gray-300"
                role="group"
              >
                <button
                  type="button"
                  class="period-btn px-3 py-2 text-sm font-medium text-gray-900 bg-white border-r border-gray-300 hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-indigo-500 focus:text-indigo-600 active"
                  data-period="daily"
                  data-i18n="global.daily"
                  onclick="setPeriod('daily')"
                >
                  Daily
                </button>
                <button
                  type="button"
                  class="period-btn px-3 py-2 text-sm font-medium text-gray-900 bg-white border-r border-gray-300 hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-indigo-500 focus:text-indigo-600"
                  data-period="weekly"
                  data-i18n="global.weekly"
                  onclick="setPeriod('weekly')"
                >
                  Weekly
                </button>
                <button
                  type="button"
                  class="period-btn px-3 py-2 text-sm font-medium text-gray-900 bg-white border-r border-gray-300 hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-indigo-500 focus:text-indigo-600"
                  data-period="monthly"
                  data-i18n="global.monthly"
                  onclick="setPeriod('monthly')"
                >
                  Monthly
                </button>
                <button
                  type="button"
                  class="period-btn px-3 py-2 text-sm font-medium text-gray-900 bg-white hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-indigo-500 focus:text-indigo-600"
                  data-period="annually"
                  data-i18n="global.annually"
                  onclick="setPeriod('annually')"
                >
                  Annually
                </button>
              </div>
            </div>

            <!-- Daily Summary -->
            <div
              class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 mb-6"
            >
              <div
                class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-500"
              >
                <div
                  id="daily-total-sales"
                  class="text-xl font-bold text-gray-800"
                >
                  0
                </div>
                <div
                  class="text-gray-600 text-sm"
                  data-i18n="tabs.sales.total_sales"
                >
                  Total Sales
                </div>
              </div>
              <div
                class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500"
              >
                <div
                  id="daily-total-revenue"
                  class="text-xl font-bold text-gray-800"
                >
                  ₹0
                </div>
                <div
                  class="text-gray-600 text-sm"
                  data-i18n="tabs.sales.total_revenue"
                >
                  Total Revenue
                </div>
              </div>
              <div
                class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500"
              >
                <div
                  id="daily-total-profit"
                  class="text-xl font-bold text-gray-800"
                >
                  ₹0
                </div>
                <div
                  class="text-gray-600 text-sm"
                  data-i18n="tabs.sales.total_profit"
                >
                  Total Profit
                </div>
              </div>
            </div>

            <!-- Sales Table -->
            <div class="overflow-x-auto">
              <table
                class="min-w-full bg-white border border-gray-200 rounded-lg"
              >
                <thead>
                  <tr class="bg-gray-100">
                    <th
                      class="py-2 px-4 border-b text-left"
                      data-i18n="tabs.sales.table.product"
                    >
                      Product
                    </th>
                    <th
                      class="py-2 px-4 border-b text-right"
                      data-i18n="tabs.sales.table.cost_price"
                    >
                      Cost Price
                    </th>
                    <th
                      class="py-2 px-4 border-b text-right"
                      data-i18n="tabs.sales.table.selling_price"
                    >
                      Selling Price
                    </th>
                    <th
                      class="py-2 px-4 border-b text-right"
                      data-i18n="tabs.sales.table.profit"
                    >
                      Profit
                    </th>
                  </tr>
                </thead>
                <tbody id="sales-table-body">
                  <!-- Sales data will be populated here -->
                </tbody>
              </table>
              <div
                id="no-sales-message"
                class="text-center py-4 text-gray-500 hidden"
                data-i18n="tabs.sales.no_sales"
              >
                No sales recorded for this day.
              </div>
            </div>
          </div>
        </div>

        <!-- Expenses -->
        <div id="expense-form" class="form-section">
          <h2 class="text-xl font-bold mb-4" data-i18n="tabs.expenses.title">
            Expense Management
          </h2>

          <!-- Expenses Tabs -->
          <div class="flex mb-4 bg-gray-100 rounded-lg overflow-hidden">
            <button
              class="expenses-tab flex-1 p-3 text-gray-700 active hover:not-active:bg-gray-200 active:bg-indigo-600 active:text-white"
              onclick="showExpensesTab(event, 'add-expense')"
              data-i18n="tabs.expenses.add_expense"
            >
              Add Expense
            </button>
            <button
              class="expenses-tab flex-1 p-3 text-gray-700 hover:not-active:bg-gray-200"
              onclick="showExpensesTab(event, 'view-expenses')"
              data-i18n="tabs.expenses.view_expense"
            >
              View Expenses
            </button>
          </div>

          <!-- Add Expense Form -->
          <div id="add-expense" class="expenses-content active">
            <h3
              class="text-lg font-semibold mb-3"
              data-i18n="tabs.expenses.add_new_expense"
            >
              Add New Expense
            </h3>
            <form id="expenseForm" class="space-y-4">
              <div>
                <label
                  for="description"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.expenses.form.description"
                  >Description</label
                >
                <input
                  id="description"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="category"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.expenses.form.category"
                  >Category</label
                >
                <select
                  id="category"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500"
                >
                  <option
                    value=""
                    data-i18n="tabs.expenses.form.select_category"
                  >
                    Select Category
                  </option>
                  <option data-i18n="tabs.expenses.form.category_rent">
                    Rent
                  </option>
                  <option data-i18n="tabs.expenses.form.category_utilities">
                    Utilities
                  </option>
                  <option data-i18n="tabs.expenses.form.category_supplies">
                    Supplies
                  </option>
                  <option data-i18n="tabs.expenses.form.category_staff">
                    Staff
                  </option>
                  <option data-i18n="tabs.expenses.form.category_maintenance">
                    Maintenance
                  </option>
                  <option data-i18n="tabs.expenses.form.category_other">
                    Other
                  </option>
                </select>
              </div>
              <div>
                <label
                  for="amount"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.expenses.form.amount"
                  >Amount (₹)</label
                >
                <input
                  type="number"
                  id="amount"
                  step="0.01"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500"
                />
              </div>
              <button
                type="submit"
                class="submit-btn w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg"
                data-i18n="tabs.expenses.form.submit"
              >
                Add Expense
              </button>
            </form>
            <div
              id="expense-message"
              class="mt-3 text-center font-semibold hidden"
            ></div>
          </div>

          <!-- View Expenses -->
          <div id="view-expenses" class="expenses-content hidden">
            <div class="flex flex-wrap justify-between items-center mb-4">
              <div class="flex gap-2 items-center">
                <div id="expenses-spinner-insert"></div>

                <h3
                  class="text-lg font-semibold"
                  data-i18n="tabs.expenses.expenses_view"
                >
                  Expenses View
                </h3>
              </div>
              <div class="flex items-center space-x-2">
                <button
                  class="date-nav-btn"
                  onclick="changeExpensesDate(-1)"
                  data-i18n="tabs.sales.previous"
                >
                  ← Previous
                </button>
                <span
                  id="expenses-selected-date"
                  class="font-medium px-3 py-1 bg-indigo-100 rounded-lg"
                ></span>
                <button
                  class="date-nav-btn"
                  onclick="changeExpensesDate(1)"
                  data-i18n="tabs.sales.next"
                >
                  Next →
                </button>
              </div>
            </div>

            <!-- Period Filter Buttons -->
            <div class="flex mb-4">
              <div
                class="inline-flex rounded-lg overflow-hidden border border-gray-300"
                role="group"
              >
                <button
                  type="button"
                  class="expenses-period-btn px-3 py-2 text-sm font-medium text-gray-900 bg-white border-r border-gray-300 hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-indigo-500 focus:text-indigo-600 active"
                  data-expenses-period="daily"
                  data-i18n="global.daily"
                  onclick="setExpensesPeriod('daily')"
                >
                  Daily
                </button>
                <button
                  type="button"
                  class="expenses-period-btn px-3 py-2 text-sm font-medium text-gray-900 bg-white border-r border-gray-300 hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-indigo-500 focus:text-indigo-600"
                  data-expenses-period="weekly"
                  data-i18n="global.weekly"
                  onclick="setExpensesPeriod('weekly')"
                >
                  Weekly
                </button>
                <button
                  type="button"
                  class="expenses-period-btn px-3 py-2 text-sm font-medium text-gray-900 bg-white border-r border-gray-300 hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-indigo-500 focus:text-indigo-600"
                  data-expenses-period="monthly"
                  data-i18n="global.monthly"
                  onclick="setExpensesPeriod('monthly')"
                >
                  Monthly
                </button>
                <button
                  type="button"
                  class="expenses-period-btn px-3 py-2 text-sm font-medium text-gray-900 bg-white hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-indigo-500 focus:text-indigo-600"
                  data-expenses-period="annually"
                  data-i18n="global.annually"
                  onclick="setExpensesPeriod('annually')"
                >
                  Annually
                </button>
              </div>
            </div>

            <!-- Daily Summary -->
            <div
              class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 mb-6"
            >
              <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                <div
                  id="daily-total-expenses"
                  class="text-xl font-bold text-gray-800"
                >
                  0
                </div>
                <div
                  class="text-gray-600 text-sm"
                  data-i18n="tabs.expenses.total_expenses"
                >
                  Total Expenses
                </div>
              </div>
              <div
                class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500"
              >
                <div
                  id="daily-total-amount"
                  class="text-xl font-bold text-gray-800"
                >
                  ₹0
                </div>
                <div
                  class="text-gray-600 text-sm"
                  data-i18n="tabs.expenses.total_amount"
                >
                  Total Amount
                </div>
              </div>
              <div
                class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500"
              >
                <div
                  id="daily-categories-count"
                  class="text-xl font-bold text-gray-800"
                >
                  0
                </div>
                <div
                  class="text-gray-600 text-sm"
                  data-i18n="tabs.expenses.categories"
                >
                  Categories
                </div>
              </div>
            </div>

            <!-- Expenses Table -->
            <div class="overflow-x-auto">
              <table
                class="min-w-full bg-white border border-gray-200 rounded-lg"
              >
                <thead>
                  <tr class="bg-gray-100">
                    <th
                      class="py-2 px-4 border-b text-left"
                      data-i18n="tabs.expenses.table.description"
                    >
                      Description
                    </th>
                    <th
                      class="py-2 px-4 border-b text-left"
                      data-i18n="tabs.expenses.table.category"
                    >
                      Category
                    </th>
                    <th
                      class="py-2 px-4 border-b text-right"
                      data-i18n="tabs.expenses.table.amount"
                    >
                      Amount
                    </th>
                  </tr>
                </thead>
                <tbody id="expenses-table-body">
                  <!-- Expenses data will be populated here -->
                </tbody>
              </table>
              <div
                id="no-expenses-message"
                class="text-center py-4 text-gray-500 hidden"
                data-i18n="tabs.expenses.no_expenses"
              >
                No expenses recorded for this day.
              </div>
            </div>
          </div>
        </div>

        <!-- Loans -->
        <div id="loan-form" class="form-section">
          <h2 class="text-xl font-bold mb-4" data-i18n="tabs.loans.title">
            Loan Management
          </h2>

          <!-- Loans Tabs -->
          <div class="flex mb-4 bg-gray-100 rounded-lg overflow-hidden">
            <button
              class="loans-tab flex-1 p-3 text-gray-700 active hover:not-active:bg-gray-200 active:bg-indigo-600 active:text-white"
              onclick="showLoansTab(event, 'add-loan')"
              data-i18n="tabs.loans.add_loan"
            >
              Add Loan
            </button>
            <button
              class="loans-tab flex-1 p-3 text-gray-700 hover:not-active:bg-gray-200"
              onclick="showLoansTab(event, 'view-loans')"
              data-i18n="tabs.loans.view_loans"
            >
              View Loans
            </button>
          </div>

          <!-- Add Loan Form -->
          <div id="add-loan" class="loans-content active">
            <h3
              class="text-lg font-semibold mb-3"
              data-i18n="tabs.loans.add_new_loan"
            >
              Add New Loan Entry
            </h3>
            <form id="loanForm" class="space-y-4">
              <div>
                <label
                  for="loanType"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.loans.form.type"
                  >Type</label
                >
                <select
                  id="loanType"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500"
                >
                  <option value="" data-i18n="tabs.loans.form.select_type">
                    Select Type
                  </option>
                  <option data-i18n="tabs.loans.form.type_taken">
                    Loan Taken
                  </option>
                  <option data-i18n="tabs.loans.form.type_repaid">
                    Loan Repaid
                  </option>
                </select>
              </div>
              <div>
                <label
                  for="person"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.loans.form.person"
                  >Person/Organization</label
                >
                <input
                  id="person"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="loanAmount"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.loans.form.amount"
                  >Amount (₹)</label
                >
                <input
                  type="number"
                  id="loanAmount"
                  step="0.01"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="status"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.loans.form.status"
                  >Status</label
                >
                <select
                  id="status"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500"
                >
                  <option data-i18n="tabs.loans.form.status_pending">
                    Pending
                  </option>
                  <option data-i18n="tabs.loans.form.status_completed">
                    Completed
                  </option>
                  <option data-i18n="tabs.loans.form.status_overdue">
                    Overdue
                  </option>
                </select>
              </div>
              <div>
                <label
                  for="loanNotes"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.loans.form.notes"
                  >Notes (Optional)</label
                >
                <textarea
                  id="loanNotes"
                  rows="3"
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500"
                ></textarea>
              </div>
              <button
                type="submit"
                class="submit-btn w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg"
                data-i18n="tabs.loans.form.submit"
              >
                Add Loan Entry
              </button>
            </form>
            <div
              id="loan-message"
              class="mt-3 text-center font-semibold hidden"
            ></div>
          </div>

          <!-- View Loans -->
          <div id="view-loans" class="loans-content hidden">
            <div class="flex flex-wrap justify-between items-center mb-4">
              <div class="flex gap-2 items-center">
                <div id="loans-spinner-insert"></div>

                <h3
                  class="text-lg font-semibold"
                  data-i18n="tabs.loans.daily_loans"
                >
                  Daily Loans
                </h3>
              </div>
              <div class="flex items-center space-x-2">
                <button
                  class="date-nav-btn"
                  onclick="changeLoansDate(-1)"
                  data-i18n="tabs.sales.previous"
                >
                  ← Previous
                </button>
                <span
                  id="loans-selected-date"
                  class="font-medium px-3 py-1 bg-indigo-100 rounded-lg"
                ></span>
                <button
                  class="date-nav-btn"
                  onclick="changeLoansDate(1)"
                  data-i18n="tabs.sales.next"
                >
                  Next →
                </button>
              </div>
            </div>

            <!-- Daily Summary -->
            <div
              class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 mb-6"
            >
              <div
                class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-500"
              >
                <div
                  id="daily-total-loans"
                  class="text-xl font-bold text-gray-800"
                >
                  0
                </div>
                <div
                  class="text-gray-600 text-sm"
                  data-i18n="tabs.loans.total_loans"
                >
                  Total Loans
                </div>
              </div>
              <div
                class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500"
              >
                <div
                  id="daily-loans-taken"
                  class="text-xl font-bold text-gray-800"
                >
                  ₹0
                </div>
                <div
                  class="text-gray-600 text-sm"
                  data-i18n="tabs.loans.loans_taken"
                >
                  Loans Taken
                </div>
              </div>
              <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                <div
                  id="daily-loans-repaid"
                  class="text-xl font-bold text-gray-800"
                >
                  ₹0
                </div>
                <div
                  class="text-gray-600 text-sm"
                  data-i18n="tabs.loans.loans_repaid"
                >
                  Loans Repaid
                </div>
              </div>
            </div>

            <!-- Loans Table -->
            <div class="overflow-x-auto">
              <table
                class="min-w-full bg-white border border-gray-200 rounded-lg"
              >
                <thead>
                  <tr class="bg-gray-100">
                    <th
                      class="py-2 px-4 border-b text-left"
                      data-i18n="tabs.loans.table.type"
                    >
                      Type
                    </th>
                    <th
                      class="py-2 px-4 border-b text-left"
                      data-i18n="tabs.loans.table.person"
                    >
                      Person/Organization
                    </th>
                    <th
                      class="py-2 px-4 border-b text-right"
                      data-i18n="tabs.loans.table.amount"
                    >
                      Amount
                    </th>
                    <th
                      class="py-2 px-4 border-b text-left"
                      data-i18n="tabs.loans.table.status"
                    >
                      Status
                    </th>
                  </tr>
                </thead>
                <tbody id="loans-table-body">
                  <!-- Loans data will be populated here -->
                </tbody>
              </table>
              <div
                id="no-loans-message"
                class="text-center py-4 text-gray-500 hidden"
                data-i18n="tabs.loans.no_loans"
              >
                No loans recorded for this day.
              </div>
            </div>
          </div>
        </div>

        <!-- Dues -->
        <div id="due-form" class="form-section">
          <h2 class="text-xl font-bold mb-4" data-i18n="tabs.dues.title">
            Dues Management
          </h2>

          <!-- Dues Tabs -->
          <div class="flex mb-4 bg-gray-100 rounded-lg overflow-hidden">
            <button
              class="dues-tab flex-1 p-3 text-gray-700 active hover:not-active:bg-gray-200 active:bg-indigo-600 active:text-white"
              onclick="showDuesTab(event, 'add-due')"
              data-i18n="tabs.dues.add_due"
            >
              Add Due
            </button>
            <button
              class="dues-tab flex-1 p-3 text-gray-700 hover:not-active:bg-gray-200"
              onclick="showDuesTab(event, 'view-dues')"
              data-i18n="tabs.dues.view_dues"
            >
              View Dues
            </button>
          </div>

          <!-- Add Due Form -->
          <div id="add-due" class="dues-content active">
            <h3
              class="text-lg font-semibold mb-3"
              data-i18n="tabs.dues.add_new_due"
            >
              Add New Due Entry
            </h3>
            <form id="dueForm" class="space-y-4">
              <div>
                <label
                  for="customerName"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.dues.form.customer_name"
                  >Customer Name</label
                >
                <input
                  id="customerName"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="dueAmount"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.dues.form.amount_due"
                  >Amount Due (₹)</label
                >
                <input
                  type="number"
                  id="dueAmount"
                  step="0.01"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="dueStatus"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.dues.form.status"
                  >Status</label
                >
                <select
                  id="dueStatus"
                  required
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500"
                >
                  <option data-i18n="tabs.dues.form.status_pending">
                    Pending
                  </option>
                  <option data-i18n="tabs.dues.form.status_paid">Paid</option>
                  <option data-i18n="tabs.dues.form.status_overdue">
                    Overdue
                  </option>
                </select>
              </div>
              <div>
                <label
                  for="dueNotes"
                  class="block font-semibold text-gray-700 mb-1"
                  data-i18n="tabs.dues.form.notes"
                  >Notes (Optional)</label
                >
                <textarea
                  id="dueNotes"
                  rows="3"
                  class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-indigo-500"
                ></textarea>
              </div>
              <button
                type="submit"
                class="submit-btn w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg"
                data-i18n="tabs.dues.form.submit"
              >
                Add Due Entry
              </button>
            </form>
            <div
              id="due-message"
              class="mt-3 text-center font-semibold hidden"
            ></div>
          </div>

          <!-- View Dues -->
          <div id="view-dues" class="dues-content hidden">
            <div class="flex flex-wrap justify-between items-center mb-4">
              <div class="flex gap-2 items-center">
                <div id="dues-spinner-insert"></div>

                <h3
                  class="text-lg font-semibold"
                  data-i18n="tabs.dues.daily_dues"
                >
                  Daily Dues
                </h3>
              </div>
              <div class="flex items-center space-x-2">
                <button
                  class="date-nav-btn"
                  onclick="changeDuesDate(-1)"
                  data-i18n="tabs.sales.previous"
                >
                  ← Previous
                </button>
                <span
                  id="dues-selected-date"
                  class="font-medium px-3 py-1 bg-indigo-100 rounded-lg"
                ></span>
                <button
                  class="date-nav-btn"
                  onclick="changeDuesDate(1)"
                  data-i18n="tabs.sales.next"
                >
                  Next →
                </button>
              </div>
            </div>

            <!-- Daily Summary -->
            <div
              class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 mb-6"
            >
              <div
                class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500"
              >
                <div
                  id="daily-total-dues"
                  class="text-xl font-bold text-gray-800"
                >
                  0
                </div>
                <div
                  class="text-gray-600 text-sm"
                  data-i18n="tabs.dues.total_dues"
                >
                  Total Dues
                </div>
              </div>
              <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                <div
                  id="daily-pending-dues"
                  class="text-xl font-bold text-gray-800"
                >
                  ₹0
                </div>
                <div
                  class="text-gray-600 text-sm"
                  data-i18n="tabs.dues.pending_dues"
                >
                  Pending Dues
                </div>
              </div>
              <div
                class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500"
              >
                <div
                  id="daily-paid-dues"
                  class="text-xl font-bold text-gray-800"
                >
                  ₹0
                </div>
                <div
                  class="text-gray-600 text-sm"
                  data-i18n="tabs.dues.paid_dues"
                >
                  Paid Dues
                </div>
              </div>
            </div>

            <!-- Dues Table -->
            <div class="overflow-x-auto">
              <table
                class="min-w-full bg-white border border-gray-200 rounded-lg"
              >
                <thead>
                  <tr class="bg-gray-100">
                    <th
                      class="py-2 px-4 border-b text-left"
                      data-i18n="tabs.dues.table.customer"
                    >
                      Customer Name
                    </th>
                    <th
                      class="py-2 px-4 border-b text-right"
                      data-i18n="tabs.dues.table.amount"
                    >
                      Amount
                    </th>
                    <th
                      class="py-2 px-4 border-b text-left"
                      data-i18n="tabs.dues.table.status"
                    >
                      Status
                    </th>
                    <th
                      class="py-2 px-4 border-b text-left"
                      data-i18n="tabs.dues.table.notes"
                    >
                      Notes
                    </th>
                  </tr>
                </thead>
                <tbody id="dues-table-body">
                  <!-- Dues data will be populated here -->
                </tbody>
              </table>
              <div
                id="no-dues-message"
                class="text-center py-4 text-gray-500 hidden"
                data-i18n="tabs.dues.no_dues"
              >
                No dues recorded for this day.
              </div>
            </div>
          </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard-form" class="form-section">
          <h2
            class="text-xl font-bold mb-4 text-center"
            data-i18n="tabs.dashboard.title"
          >
            Business Dashboard
          </h2>
          <div class="grid grid-cols-2 gap-4 mb-5">
            <div
              class="bg-gray-100 p-4 rounded-lg border-l-4 border-indigo-500"
            >
              <div id="totalSales" class="text-2xl font-bold text-gray-800">
                0
              </div>
              <div
                class="text-gray-500 text-sm"
                data-i18n="tabs.dashboard.total_sales"
              >
                Total Sales
              </div>
            </div>
            <div
              class="bg-gray-100 p-4 rounded-lg border-l-4 border-indigo-500"
            >
              <div id="totalProfit" class="text-2xl font-bold text-gray-800">
                ₹0
              </div>
              <div
                class="text-gray-500 text-sm"
                data-i18n="tabs.dashboard.total_profit"
              >
                Total Profit
              </div>
            </div>
            <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-green-600">
              <div id="savings" class="text-2xl font-bold text-gray-800">
                ₹0
              </div>
              <div
                class="text-gray-500 text-sm"
                data-i18n="tabs.dashboard.savings"
              >
                Savings (40%)
              </div>
            </div>
            <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-red-500">
              <div id="reinvestment" class="text-2xl font-bold text-gray-800">
                ₹0
              </div>
              <div
                class="text-gray-500 text-sm"
                data-i18n="tabs.dashboard.reinvestment"
              >
                Reinvestment (60%)
              </div>
            </div>
          </div>
          <button
            class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg"
            onclick="loadDashboard()"
            data-i18n="tabs.dashboard.refresh"
          >
            Refresh Data
          </button>
        </div>
      </div>
    </div>
    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbzOtNC9Bgq6Kl5Pw27ucwuVC3kAcfQ-EUFKP65vjL_5VEMv3xdKe2rSPa0V8mgghUrguw/exec";

      const spinnerDiv = document.getElementById("spinnerDiv");

      let paymentMethodsList = [];
      let splitPaymentRows = [];
      // Current date for sales view
      let currentViewDate = new Date();
      // Current dates for other views
      let currentExpensesDate = new Date();
      let currentLoansDate = new Date();
      let currentDuesDate = new Date();
      // Current periods for all views
      let currentSalesPeriod = "daily";
      let currentExpensesPeriod = "daily";
      let currentLoansPeriod = "daily";
      let currentDuesPeriod = "daily";

      const sellingPriceInput = document.getElementById("sellingPrice");
      const costPriceInput = document.getElementById("costPrice");
      const profitBadge = document.getElementById("instantProfitBadge");

      function updateProfitBadge() {
        const selling = parseFloat(sellingPriceInput.value) || 0;
        const cost = parseFloat(costPriceInput.value) || 0;
        const profit = selling - cost;

        if (!profit || selling === 0 || cost === 0) {
          profitBadge.classList.add("hidden");
          profitBadge.classList.remove("opacity-100");
          return;
        }

        profitBadge.textContent = `${profit >= 0 ? "+" : "-"}₹${Math.abs(
          profit
        )}`;

        profitBadge.classList.remove("hidden");
        profitBadge.style.backgroundColor = profit >= 0 ? "#bbf7d0" : "#fecaca"; // green-200 / red-200
        profitBadge.style.color = profit >= 0 ? "#166534" : "#991b1b"; // green-800 / red-800

        setTimeout(() => {
          profitBadge.classList.add("opacity-100");
        }, 10);
      }

      sellingPriceInput.addEventListener("input", updateProfitBadge);
      costPriceInput.addEventListener("input", updateProfitBadge);
      // Incremental instant update
      function incrementSalesSummary(newSale) {
        const countEl = document.getElementById("itemsSold");
        const revenueEl = document.getElementById("salesAmount");
        const profitEl = document.getElementById("profitAmount");

        const cost = parseFloat(newSale.costPrice);
        const sell = parseFloat(newSale.sellingPrice);
        const profit = sell - cost;

        // Update numbers instantly
        countEl.textContent = parseInt(countEl.textContent) + 1;
        revenueEl.textContent = `₹${(
          parseFloat(revenueEl.textContent.replace("₹", "")) + sell
        ).toFixed(2)}`;
        profitEl.textContent = `₹${(
          parseFloat(profitEl.textContent.replace("₹", "")) + profit
        ).toFixed(2)}`;

        // Visual dopamine bump 💥
        [countEl, revenueEl, profitEl].forEach((el) => {
          el.classList.add("scale-110", "text-green-500");
          setTimeout(
            () => el.classList.remove("scale-110", "text-green-500"),
            300
          );
        });
      }
      // Format date as YYYY-MM-DD
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // Format date for display
      function formatDateDisplay(date) {
        const options = {
          weekday: "short",
          year: "numeric",
          month: "short",
          day: "numeric",
        };
        return date.toLocaleDateString("en-US", options);
      }

      // Change date for sales view
      function changeDate(days) {
        currentViewDate.setDate(currentViewDate.getDate() + days);
        updateDateDisplay();
        loadSalesData();
      }

      // Update the date display
      function updateDateDisplay() {
        document.getElementById("selected-date").textContent =
          formatDateDisplay(currentViewDate);
      }

      // Update expenses date display
      function updateExpensesDateDisplay() {
        document.getElementById("expenses-selected-date").textContent =
          formatDateDisplay(currentExpensesDate);
      }

      // Update loans date display
      function updateLoansDateDisplay() {
        document.getElementById("loans-selected-date").textContent =
          formatDateDisplay(currentLoansDate);
      }

      // Update dues date display
      function updateDuesDateDisplay() {
        document.getElementById("dues-selected-date").textContent =
          formatDateDisplay(currentDuesDate);
      }

      // Change date for expenses view
      window.changeExpensesDate = function (days) {
        currentExpensesDate.setDate(currentExpensesDate.getDate() + days);
        updateExpensesDateDisplay();
        loadExpensesData();
      };

      // Change date for loans view
      window.changeLoansDate = function (days) {
        currentLoansDate.setDate(currentLoansDate.getDate() + days);
        updateLoansDateDisplay();
        loadDailyLoans();
      };

      // Change date for dues view
      window.changeDuesDate = function (days) {
        currentDuesDate.setDate(currentDuesDate.getDate() + days);
        updateDuesDateDisplay();
        loadDailyDues();
      };

      // Set period for sales view
      window.setPeriod = function (period) {
        currentSalesPeriod = period;

        // Update button states
        document.querySelectorAll(".period-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document
          .querySelector(`[data-period="${period}"]`)
          .classList.add("active");

        // Reload data
        loadSalesData();
      };

      // Set period for expenses view
      window.setExpensesPeriod = function (period) {
        currentExpensesPeriod = period;

        // Update button states
        document.querySelectorAll(".expenses-period-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document
          .querySelector(`[data-expenses-period="${period}"]`)
          .classList.add("active");

        // Reload data
        loadExpensesData();
      };

      // Set period for loans view
      window.setLoansPeriod = function (period) {
        currentLoansPeriod = period;

        // Update button states
        document.querySelectorAll(".loans-period-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document
          .querySelector(`[data-loans-period="${period}"]`)
          .classList.add("active");

        // Reload data
        loadLoansData();
      };

      // Set period for dues view
      window.setDuesPeriod = function (period) {
        currentDuesPeriod = period;

        // Update button states
        document.querySelectorAll(".dues-period-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document
          .querySelector(`[data-dues-period="${period}"]`)
          .classList.add("active");

        // Reload data
        loadDuesData();
      };

      // Show main tabs
      function showTab(event, tabName) {
        // Hide all forms
        document.querySelectorAll(".form-section").forEach((section) => {
          section.classList.remove("active");
        });

        // Remove active class from all tabs
        document.querySelectorAll(".nav-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected form and activate tab
        document.getElementById(tabName + "-form").classList.add("active");
        event.target.classList.add("active");

        // If dashboard is selected, load dashboard data
        if (tabName === "dashboard") {
          loadDashboard();
        }

        // If sales is selected, load today's sales
        if (tabName === "sale") {
          // Reset to today's date
          currentViewDate = new Date();
          updateDateDisplay();
          // Set default tab to add sale
          showSalesTab(null, "add-sale");
        }

        // If expenses is selected, reset to today's date
        if (tabName === "expense") {
          currentExpensesDate = new Date();
          updateExpensesDateDisplay();
          // Set default tab to add expense
          showExpensesTab(null, "add-expense");
        }

        // If loans is selected, reset to today's date
        if (tabName === "loan") {
          currentLoansDate = new Date();
          updateLoansDateDisplay();
          // Set default tab to add loan
          showLoansTab(null, "add-loan");
        }

        // If dues is selected, reset to today's date
        if (tabName === "due") {
          currentDuesDate = new Date();
          updateDuesDateDisplay();
          // Set default tab to add due
          showDuesTab(null, "add-due");
        }
      }

      // Show sales tabs
      function showSalesTab(event, tabName) {
        // Hide all sales content
        document.querySelectorAll(".sales-content").forEach((section) => {
          section.classList.add("hidden");
        });

        // Remove active class from all sales tabs
        document.querySelectorAll(".sales-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected sales content and activate tab
        document.getElementById(tabName).classList.remove("hidden");
        if (event) {
          event.target.classList.add("active");
        } else {
          // Default to first tab if no event
          document.querySelector(".sales-tab").classList.add("active");
        }

        // If viewing sales, load the data
        if (tabName === "view-sales") {
          loadSalesData();
        }
      }

      // Show expenses tabs
      function showExpensesTab(event, tabName) {
        // Hide all expenses content
        document.querySelectorAll(".expenses-content").forEach((section) => {
          section.classList.add("hidden");
          section.classList.remove("active");
        });
        document.getElementById(tabName).classList.add("active");

        // Remove active class from all expenses tabs
        document.querySelectorAll(".expenses-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected expenses content and activate tab
        document.getElementById(tabName).classList.remove("hidden");
        if (event) {
          event.target.classList.add("active");
        } else {
          // Default to first tab if no event
          document.querySelector(".expenses-tab").classList.add("active");
        }

        // If viewing expenses, load the data
        if (tabName === "view-expenses") {
          loadExpensesData();
        }
      }

      // Show loans tabs
      function showLoansTab(event, tabName) {
        // Hide all loans content
        document.querySelectorAll(".loans-content").forEach((section) => {
          section.classList.add("hidden");
          section.classList.remove("active");
        });

        document.getElementById(tabName).classList.add("active");

        // Remove active class from all loans tabs
        document.querySelectorAll(".loans-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected loans content and activate tab
        document.getElementById(tabName).classList.remove("hidden");
        if (event) {
          event.target.classList.add("active");
        } else {
          // Default to first tab if no event
          document.querySelector(".loans-tab").classList.add("active");
        }

        // If viewing loans, load the data
        if (tabName === "view-loans") {
          loadDailyLoans();
        }
      }

      // Show dues tabs
      function showDuesTab(event, tabName) {
        // Hide all dues content
        document.querySelectorAll(".dues-content").forEach((section) => {
          section.classList.add("hidden");
          section.classList.remove("active");
        });
        document.getElementById(tabName).classList.add("active");

        // Remove active class from all dues tabs
        document.querySelectorAll(".dues-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected dues content and activate tab
        document.getElementById(tabName).classList.remove("hidden");
        if (event) {
          event.target.classList.add("active");
        } else {
          // Default to first tab if no event
          document.querySelector(".dues-tab").classList.add("active");
        }

        // If viewing dues, load the data
        if (tabName === "view-dues") {
          loadDailyDues();
        }
      }

      // Load sales data for the selected date and period
      async function loadSalesData() {
        try {
          const spinnerInsert = document.getElementById("spinnerInsert");
          const spinnerSvg = ` <svg
        class="mr-3 -ml-1 size-6  animate-spin text-indigo-600"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>`;
          spinnerInsert.innerHTML = spinnerSvg;
          const dateStr = formatDate(currentViewDate);
          const response = await fetch(
            `${API_URL}?type=sales&date=${dateStr}&period=${currentSalesPeriod}`,
            {
              redirect: "follow",
              method: "GET",
              headers: {
                "Content-Type": "text/plain;charset=utf-8",
              },
            }
          );

          const data = await response.json();

          // Update summary cards
          document.getElementById("daily-total-sales").textContent =
            data.totalSales || 0;
          document.getElementById("daily-total-revenue").textContent =
            "₹" + (data.totalRevenue || 0).toFixed(2);
          document.getElementById("daily-total-profit").textContent =
            "₹" + (data.totalProfit || 0).toFixed(2);

          // Update sales table
          const tableBody = document.getElementById("sales-table-body");
          const noSalesMessage = document.getElementById("no-sales-message");

          if (data.sales && data.sales.length > 0) {
            tableBody.innerHTML = "";
            noSalesMessage.classList.add("hidden");

            data.sales.forEach((sale) => {
              const profit = sale.sellingPrice - sale.costPrice;
              const row = document.createElement("tr");
              row.className = "hover:bg-gray-50";
              row.innerHTML = `
              <td class="py-2 px-4 border-b">${sale.productName}</td>
              <td class="py-2 px-4 border-b text-right">₹${sale.costPrice.toFixed(
                2
              )}</td>
              <td class="py-2 px-4 border-b text-right">₹${sale.sellingPrice.toFixed(
                2
              )}</td>
              <td class="py-2 px-4 border-b text-right">₹${profit.toFixed(
                2
              )}</td>
            `;
              tableBody.appendChild(row);
            });
          } else {
            tableBody.innerHTML = "";
            noSalesMessage.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error loading daily sales:", error);
          // Set default values if sales fail to load
          document.getElementById("daily-total-sales").textContent = "0";
          document.getElementById("daily-total-revenue").textContent = "₹0";
          document.getElementById("daily-total-profit").textContent = "₹0";
          document.getElementById("sales-table-body").innerHTML = "";
          document
            .getElementById("no-sales-message")
            .classList.remove("hidden");
        } finally {
          spinnerInsert.innerHTML = "";
        }
      }

      // Load expenses data for the selected date and period
      async function loadExpensesData() {
        try {
          const spinnerInsert = document.getElementById(
            "expenses-spinner-insert"
          );
          const spinnerSvg = ` <svg
        class="mr-3 -ml-1 size-6  animate-spin text-indigo-600"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>`;
          spinnerInsert.innerHTML = spinnerSvg;
          const dateStr = formatDate(currentExpensesDate);
          const response = await fetch(
            `${API_URL}?type=expenses&date=${dateStr}&period=${currentExpensesPeriod}`,
            {
              redirect: "follow",
              method: "GET",
              headers: {
                "Content-Type": "text/plain;charset=utf-8",
              },
            }
          );

          const data = await response.json();

          // Update summary cards
          document.getElementById("daily-total-expenses").textContent =
            data.totalExpenses || 0;
          document.getElementById("daily-total-amount").textContent =
            "₹" + (data.totalAmount || 0).toFixed(2);
          document.getElementById("daily-categories-count").textContent =
            data.categoriesCount || 0;

          // Update expenses table
          const tableBody = document.getElementById("expenses-table-body");
          const noExpensesMessage = document.getElementById(
            "no-expenses-message"
          );

          if (data.expenses && data.expenses.length > 0) {
            tableBody.innerHTML = "";
            noExpensesMessage.classList.add("hidden");

            data.expenses.forEach((expense) => {
              const row = document.createElement("tr");
              row.className = "hover:bg-gray-50";
              row.innerHTML = `
              <td class="py-2 px-4 border-b">${expense.description}</td>
              <td class="py-2 px-4 border-b">${expense.category}</td>
              <td class="py-2 px-4 border-b text-right">₹${expense.amount.toFixed(
                2
              )}</td>
            `;
              tableBody.appendChild(row);
            });
          } else {
            tableBody.innerHTML = "";
            noExpensesMessage.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error loading daily expenses:", error);
          // Set default values if expenses fail to load
          document.getElementById("daily-total-expenses").textContent = "0";
          document.getElementById("daily-total-amount").textContent = "₹0";
          document.getElementById("daily-categories-count").textContent = "0";
          document.getElementById("expenses-table-body").innerHTML = "";
          document
            .getElementById("no-expenses-message")
            .classList.remove("hidden");
        } finally {
          document.getElementById("expenses-spinner-insert").innerHTML = "";
        }
      }

      // Load daily loans for the selected date
      async function loadDailyLoans() {
        try {
          const spinnerInsert = document.getElementById("loans-spinner-insert");
          const spinnerSvg = ` <svg
        class="mr-3 -ml-1 size-6  animate-spin text-indigo-600"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>`;
          spinnerInsert.innerHTML = spinnerSvg;
          const dateStr = formatDate(currentLoansDate);
          const response = await fetch(
            `${API_URL}?type=dailyLoans&date=${dateStr}`,
            {
              redirect: "follow",
              method: "GET",
              headers: {
                "Content-Type": "text/plain;charset=utf-8",
              },
            }
          );

          const data = await response.json();

          // Update summary cards
          document.getElementById("daily-total-loans").textContent =
            data.totalLoans || 0;
          document.getElementById("daily-loans-taken").textContent =
            "₹" + (data.loansTaken || 0).toFixed(2);
          document.getElementById("daily-loans-repaid").textContent =
            "₹" + (data.loansRepaid || 0).toFixed(2);

          // Update loans table
          const tableBody = document.getElementById("loans-table-body");
          const noLoansMessage = document.getElementById("no-loans-message");

          if (data.loans && data.loans.length > 0) {
            tableBody.innerHTML = "";
            noLoansMessage.classList.add("hidden");

            data.loans.forEach((loan) => {
              const row = document.createElement("tr");
              row.className = "hover:bg-gray-50";
              row.innerHTML = `
              <td class="py-2 px-4 border-b">${loan.type}</td>
              <td class="py-2 px-4 border-b">${loan.person}</td>
              <td class="py-2 px-4 border-b text-right">₹${loan.amount.toFixed(
                2
              )}</td>
              <td class="py-2 px-4 border-b">${loan.status}</td>
            `;
              tableBody.appendChild(row);
            });
          } else {
            tableBody.innerHTML = "";
            noLoansMessage.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error loading daily loans:", error);
          // Set default values if loans fail to load
          document.getElementById("daily-total-loans").textContent = "0";
          document.getElementById("daily-loans-taken").textContent = "₹0";
          document.getElementById("daily-loans-repaid").textContent = "₹0";
          document.getElementById("loans-table-body").innerHTML = "";
          document
            .getElementById("no-loans-message")
            .classList.remove("hidden");
        } finally {
          document.getElementById("loans-spinner-insert").innerHTML = "";
        }
      }

      // Load daily dues for the selected date
      async function loadDailyDues() {
        try {
          const spinnerInsert = document.getElementById("dues-spinner-insert");
          const spinnerSvg = ` <svg
        class="mr-3 -ml-1 size-6  animate-spin text-indigo-600"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>`;
          spinnerInsert.innerHTML = spinnerSvg;
          const dateStr = formatDate(currentDuesDate);
          const response = await fetch(
            `${API_URL}?type=dailyDues&date=${dateStr}`,
            {
              redirect: "follow",
              method: "GET",
              headers: {
                "Content-Type": "text/plain;charset=utf-8",
              },
            }
          );

          const data = await response.json();

          // Update summary cards
          document.getElementById("daily-total-dues").textContent =
            data.totalDues || 0;
          document.getElementById("daily-pending-dues").textContent =
            "₹" + (data.pendingDues || 0).toFixed(2);
          document.getElementById("daily-paid-dues").textContent =
            "₹" + (data.paidDues || 0).toFixed(2);

          // Update dues table
          const tableBody = document.getElementById("dues-table-body");
          const noDuesMessage = document.getElementById("no-dues-message");

          if (data.dues && data.dues.length > 0) {
            tableBody.innerHTML = "";
            noDuesMessage.classList.add("hidden");

            data.dues.forEach((due) => {
              const row = document.createElement("tr");
              row.className = "hover:bg-gray-50";
              row.innerHTML = `
              <td class="py-2 px-4 border-b">${due.customerName}</td>
              <td class="py-2 px-4 border-b text-right">₹${due.amount.toFixed(
                2
              )}</td>
              <td class="py-2 px-4 border-b">${due.status}</td>
              <td class="py-2 px-4 border-b">${due.notes || ""}</td>
            `;
              tableBody.appendChild(row);
            });
          } else {
            tableBody.innerHTML = "";
            noDuesMessage.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error loading daily dues:", error);
          // Set default values if dues fail to load
          document.getElementById("daily-total-dues").textContent = "0";
          document.getElementById("daily-pending-dues").textContent = "₹0";
          document.getElementById("daily-paid-dues").textContent = "₹0";
          document.getElementById("dues-table-body").innerHTML = "";
          document.getElementById("no-dues-message").classList.remove("hidden");
        } finally {
          document.getElementById("dues-spinner-insert").innerHTML = "";
        }
      }

      // Sales Form Handler
      document
        .getElementById("saleForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = {
            productName: document.getElementById("productName").value,
            costPrice: parseFloat(document.getElementById("costPrice").value),
            sellingPrice: parseFloat(
              document.getElementById("sellingPrice").value
            ),
            quantity: parseInt(document.getElementById("quantity").value) || 1,
            date: document.getElementById("saleDate").value,
            notes: document.getElementById("saleNotes").value,
          };

          // Handle payment method
          if (document.getElementById("splitPaymentToggle").checked) {
            // Split payment
            const paymentBreakdown = {};
            const methodSelects = document.querySelectorAll(
              ".payment-method-select"
            );
            const amountInputs = document.querySelectorAll(".payment-amount");

            for (let i = 0; i < methodSelects.length; i++) {
              const method = methodSelects[i].value;
              const amount = parseFloat(amountInputs[i].value);
              if (method && amount > 0) {
                paymentBreakdown[method] = amount;
              }
            }

            formData.paymentMethod = paymentBreakdown;
          } else {
            // Single payment
            const paymentMethod =
              document.getElementById("paymentMethod").value;
            if (paymentMethod) {
              formData.paymentMethod = paymentMethod;
            }
          }

          submitForm("sale", formData, "sale-message")
            .then(() => {
              window.scrollTo(0, 0);
              setTimeout(() => {
                incrementSalesSummary(formData);
              }, [1600]);
            })
            .catch(console.error);
        });

      // Expense Form Handler
      document
        .getElementById("expenseForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await submitForm(
            "expense",
            {
              description: document.getElementById("description").value,
              category: document.getElementById("category").value,
              amount: parseFloat(document.getElementById("amount").value),
            },
            "expense-message"
          );
        });

      // Loan Form Handler
      document
        .getElementById("loanForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await submitForm(
            "loan",
            {
              type: document.getElementById("loanType").value,
              person: document.getElementById("person").value,
              amount: parseFloat(document.getElementById("loanAmount").value),
              status: document.getElementById("status").value,
              notes: document.getElementById("loanNotes").value,
            },
            "loan-message"
          );
        });

      // Due Form Handler
      document
        .getElementById("dueForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await submitForm(
            "due",
            {
              customerName: document.getElementById("customerName").value,
              amount: parseFloat(document.getElementById("dueAmount").value),
              status: document.getElementById("dueStatus").value,
              notes: document.getElementById("dueNotes").value,
            },
            "due-message"
          );
        });

      async function submitForm(type, data, messageElementId) {
        const messageElement = document.getElementById(messageElementId);
        const button = document.querySelector(
          `#${type}Form button[type=submit]`
        );

        const originalText = button.textContent;

        console.log(button, `#${type}Form button[type=submit]`, originalText);

        const spinnerSvg = ` <svg
        class="mr-3 -ml-1 size-6  animate-spin text-white"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>`;
        try {
          button.disabled = true;

          button.innerHTML = spinnerSvg + originalText;

          const response = await fetch(API_URL, {
            redirect: "follow",
            method: "POST",
            headers: {
              "Content-Type": "text/plain;charset=utf-8",
            },
            body: JSON.stringify({
              type: type,
              ...data,
            }),
          });

          const result = await response.json();

          if (result.status === "success") {
            messageElement.textContent = result.message;
            messageElement.className =
              "mt-3 text-center font-semibold message success";
            messageElement.classList.remove("hidden");
            const form = document.getElementById(`${type}Form`);
            form.reset();

            // If we're in the sales view, refresh the data
            if (
              type === "sale" &&
              document
                .getElementById("view-sales")
                .classList.contains("hidden") === false
            ) {
              loadSalesData();
            }

            // If we're in the expenses view, refresh the data
            if (
              type === "expense" &&
              document
                .getElementById("view-expenses")
                .classList.contains("hidden") === false
            ) {
              loadExpensesData();
            }

            // If we're in the loans view, refresh the data
            if (
              type === "loan" &&
              document
                .getElementById("view-loans")
                .classList.contains("hidden") === false
            ) {
              loadDailyLoans();
            }

            // If we're in the dues view, refresh the data
            if (
              type === "due" &&
              document
                .getElementById("view-dues")
                .classList.contains("hidden") === false
            ) {
              loadDailyDues();
            }

            // Refresh vault amount after any transaction
            loadVaultAmount();
          } else {
            throw new Error(result.message);
          }
        } catch (error) {
          messageElement.textContent = "Error: " + error.message;
          messageElement.className =
            "mt-3 text-center font-semibold message error";
          messageElement.classList.remove("hidden");
        } finally {
          button.disabled = false;
          button.textContent = getButtonText(type);

          // Clear message after 3 seconds
          setTimeout(() => {
            messageElement.textContent = "";
            messageElement.className = "mt-3 text-center font-semibold hidden";
          }, 3000);
        }
      }

      function getButtonText(type) {
        const buttonTexts = {
          sale: "Add Sale",
          expense: "Add Expense",
          loan: "Add Loan Entry",
          due: "Add Due Entry",
        };
        return buttonTexts[type];
      }

      async function loadDashboard() {
        try {
          const response = await fetch(API_URL + "?type=dashboard", {
            redirect: "follow",
            method: "GET",
            headers: {
              "Content-Type": "text/plain;charset=utf-8",
            },
          });
          const data = await response.json();

          document.getElementById("totalSales").textContent =
            data.totalSales || 0;
          document.getElementById("totalProfit").textContent =
            "₹" + (data.totalProfit || 0).toFixed(2);
          document.getElementById("savings").textContent =
            "₹" + (data.savings || 0).toFixed(2);
          document.getElementById("reinvestment").textContent =
            "₹" + (data.reinvestment || 0).toFixed(2);
        } catch (error) {
          console.error("Error loading dashboard:", error);
          // Set default values if dashboard fails to load
          document.getElementById("totalSales").textContent = "0";
          document.getElementById("totalProfit").textContent = "₹0";
          document.getElementById("savings").textContent = "₹0";
          document.getElementById("reinvestment").textContent = "₹0";
        }
      }

      async function loadVaultAmount() {
        // Show cached value immediately to prevent UI jitter
        const cached = localStorage.getItem("vaultAmount");
        if (cached) document.getElementById("vaultAmount").textContent = cached;

        try {
          const response = await fetch(API_URL + "?type=vault", {
            redirect: "follow",
            method: "GET",
            headers: {
              "Content-Type": "text/plain;charset=utf-8",
            },
          });
          const data = await response.json();

          if (data.status === "success") {
            const amount = (data.vaultAmount || 0).toFixed(2);
            document.getElementById("vaultAmount").textContent = amount;
            localStorage.setItem("vaultAmount", amount);
          }
        } catch (error) {
          console.error("Error loading vault amount:", error);
          document.getElementById("vaultAmount").textContent = "0.00";
        }
      }

      // Initialize the page
      document.addEventListener("DOMContentLoaded", () => {
        // Set default date for sale form to today
        document.getElementById("saleDate").value = formatDate(new Date());

        // Set up initial active tabs
        document.querySelector(".nav-tab").classList.add("active");
        document.getElementById("sale-form").classList.add("active");
        updateDateDisplay();
        updateExpensesDateDisplay();
        updateLoansDateDisplay();
        updateDuesDateDisplay();

        // Load initial data
        loadDashboard();
        loadVaultAmount();
      });
    </script>
    <script>
      const localeSelect = document.getElementById("locale-select");

      // Check if localStorage is available
      function isLocalStorageAvailable() {
        try {
          const test = "test";
          localStorage.setItem(test, test);
          localStorage.removeItem(test);
          return true;
        } catch (e) {
          return false;
        }
      }

      // Get saved locale from localStorage or default to 'en'
      function getSavedLocale() {
        if (!isLocalStorageAvailable()) return "en";
        return localStorage.getItem("userLocale") || "en";
      }

      // Save locale to localStorage
      function saveLocale(locale) {
        if (!isLocalStorageAvailable()) return;
        localStorage.setItem("userLocale", locale);
      }

      // Get saved translations from localStorage
      function getSavedTranslations(locale) {
        if (!isLocalStorageAvailable()) return null;
        const saved = localStorage.getItem(`translations_${locale}`);
        return saved ? JSON.parse(saved) : null;
      }

      // Save translations to localStorage
      function saveTranslations(locale, translations) {
        if (!isLocalStorageAvailable()) return;
        localStorage.setItem(
          `translations_${locale}`,
          JSON.stringify(translations)
        );
      }

      // Clear cached translations (useful for development or updates)
      function clearCachedTranslations() {
        if (!isLocalStorageAvailable()) return;
        localStorage.removeItem("translations_en");
        localStorage.removeItem("translations_ne");
        console.log("Cached translations cleared");
      }

      // Force refresh translations from server
      function refreshTranslations(locale) {
        if (!isLocalStorageAvailable()) {
          fetchTranslations(locale);
          return;
        }
        localStorage.removeItem(`translations_${locale}`);
        fetchTranslations(locale);
      }

      async function fetchTranslations(locale) {
        try {
          // Check if translations are already cached
          const cachedTranslations = getSavedTranslations(locale);
          if (cachedTranslations) {
            console.log("Using cached translations for:", locale);
            applyTranslations(cachedTranslations);
            return cachedTranslations;
          }

          // Show spinner only when fetching from server
          spinnerDiv.style.display = "flex";
          spinnerDiv.style.alignItems = "center";
          spinnerDiv.style.justifyContent = "center";

          const res = await fetch(
            `${API_URL}?type=translations&locale=${locale}`,
            {
              redirect: "follow",
              method: "GET",
              headers: {
                "Content-Type": "text/plain;charset=utf-8",
              },
            }
          );
          const data = await res.json();

          if (data.status === "success") {
            console.log("Translations fetched from server:", data.translations);

            // Cache the translations
            saveTranslations(locale, data.translations);

            applyTranslations(data.translations);
            return data.translations;
          } else {
            console.error("Translation fetch error:", data.message);
          }
        } catch (err) {
          console.error("Network error fetching translations:", err);
        } finally {
          spinnerDiv.style.display = "none";
        }
      }

      function applyTranslations(translations) {
        // Update your UI elements with translations
        // You'll need to add data-i18n attributes to your HTML
        Object.keys(translations).forEach((key) => {
          const elements = document.querySelectorAll(`[data-i18n="${key}"]`);
          elements.forEach((element) => {
            element.textContent = translations[key];
          });
        });
      }
      // Initialize locale on page load
      function initializeLocale() {
        const savedLocale = getSavedLocale();
        localeSelect.value = savedLocale;
        fetchTranslations(savedLocale);
      }

      // When locale changes
      localeSelect.addEventListener("change", (e) => {
        const locale = e.target.value;
        saveLocale(locale); // Save the new preference
        fetchTranslations(locale);
      });

      // Initialize locale when DOM is loaded
      document.addEventListener("DOMContentLoaded", initializeLocale);

      async function fetchPaymentMethods() {
        try {
          const response = await fetch(`${API_URL}?type=paymentMethods`, {
            redirect: "follow",
            method: "GET",
            headers: {
              "Content-Type": "text/plain;charset=utf-8",
            },
          });
          const data = await response.json();

          if (data.status === "success") {
            paymentMethodsList = data.paymentMethods;
            populatePaymentMethods();
          }
        } catch (error) {
          console.error("Error fetching payment methods:", error);
          // Fallback to default payment methods
          paymentMethodsList = [
            "handcash",
            "esewa_binod_kharel",
            "fonepay_subham_fancy_store",
          ];
          populatePaymentMethods();
        }
      }

      // Populate payment method dropdown
      function populatePaymentMethods() {
        const paymentMethodSelect = document.getElementById("paymentMethod");
        paymentMethodSelect.innerHTML =
          '<option value="" data-i18n="tabs.sales.form.select_payment_method">Select Payment Method</option>';

        paymentMethodsList.forEach((method) => {
          const option = document.createElement("option");
          option.value = method;
          option.textContent = getPaymentMethodDisplayName(method);
          paymentMethodSelect.appendChild(option);
        });
      }

      // Get display name for payment method
      function getPaymentMethodDisplayName(method) {
        const displayNames = {
          handcash: "Hand Cash",
          esewa_binod_kharel: "eSewa (Binod Kharel)",
          fonepay_subham_fancy_store: "Fonepay (Subham Fancy Store)",
        };
        return displayNames[method] || method;
      }

      // Add split payment functionality
      function initializeSplitPayment() {
        const toggle = document.getElementById("splitPaymentToggle");
        const singleSection = document.getElementById("single-payment-section");
        const splitSection = document.getElementById("split-payment-section");

        toggle.addEventListener("change", function () {
          if (this.checked) {
            singleSection.classList.add("hidden");
            splitSection.classList.remove("hidden");
            addSplitPaymentRow(); // Add first row
          } else {
            singleSection.classList.remove("hidden");
            splitSection.classList.add("hidden");
            clearSplitPaymentRows();
          }
          updateSplitPaymentTotal();
        });

        // Add payment method button
        document
          .getElementById("add-payment-method")
          .addEventListener("click", addSplitPaymentRow);

        // Real-time calculation updates
        document
          .getElementById("costPrice")
          .addEventListener("input", updateCalculations);
        document
          .getElementById("sellingPrice")
          .addEventListener("input", updateCalculations);
        document
          .getElementById("quantity")
          .addEventListener("input", updateCalculations);
      }

      // Add a new split payment row
      function addSplitPaymentRow() {
        const container = document.getElementById("split-payment-methods");
        const rowId = Date.now();

        const row = document.createElement("div");
        row.className = "flex gap-2 items-start";
        row.innerHTML = `
      <select class="flex-1 border border-gray-300 rounded max-w-md md:max-w-xl lg:max-w-2xl p-2 text-sm payment-method-select" required>
        <option value="">Select Method</option>
        ${paymentMethodsList
          .map(
            (method) =>
              `<option value="${method}">${getPaymentMethodDisplayName(
                method
              )}</option>`
          )
          .join("")}
      </select>
      <input type="number" step="0.01" min="0" placeholder="Amount" 
             class="max-w-24 md:max-w-32 border border-gray-300 rounded p-2 text-sm payment-amount" required>
      <button type="button" class="remove-payment-row text-red-600 hover:text-red-800 p-2" data-row="${rowId}">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    `;

        container.appendChild(row);

        // Add event listeners for the new row
        const amountInput = row.querySelector(".payment-amount");
        const methodSelect = row.querySelector(".payment-method-select");

        amountInput.addEventListener("input", updateSplitPaymentTotal);
        methodSelect.addEventListener("change", updateSplitPaymentTotal);

        // Remove row button
        row
          .querySelector(".remove-payment-row")
          .addEventListener("click", function () {
            if (container.children.length > 1) {
              row.remove();
              updateSplitPaymentTotal();
            }
          });

        splitPaymentRows.push(rowId);
      }

      // Clear all split payment rows
      function clearSplitPaymentRows() {
        const container = document.getElementById("split-payment-methods");
        container.innerHTML = "";
        splitPaymentRows = [];
      }

      // Update split payment total
      function updateSplitPaymentTotal() {
        const amountInputs = document.querySelectorAll(".payment-amount");
        let total = 0;

        amountInputs.forEach((input) => {
          total += parseFloat(input.value) || 0;
        });

        const sellingPrice =
          parseFloat(document.getElementById("sellingPrice").value) || 0;
        const quantity =
          parseInt(document.getElementById("quantity").value) || 1;
        const totalSelling = sellingPrice * quantity;

        document.getElementById(
          "split-payment-total"
        ).textContent = `₹${total.toFixed(2)}`;

        const errorElement = document.getElementById("split-payment-error");
        if (Math.abs(total - totalSelling) > 0.01 && total > 0) {
          errorElement.classList.remove("hidden");
        } else {
          errorElement.classList.add("hidden");
        }
      }

      // Update calculation summary
      function updateCalculations() {
        const costPrice =
          parseFloat(document.getElementById("costPrice").value) || 0;
        const sellingPrice =
          parseFloat(document.getElementById("sellingPrice").value) || 0;
        const quantity =
          parseInt(document.getElementById("quantity").value) || 1;

        const totalCost = costPrice * quantity;
        const totalSelling = sellingPrice * quantity;
        const totalProfit = totalSelling - totalCost;

        document.getElementById(
          "total-cost-display"
        ).textContent = `₹${totalCost.toFixed(2)}`;
        document.getElementById(
          "total-selling-display"
        ).textContent = `₹${totalSelling.toFixed(2)}`;
        document.getElementById(
          "total-profit-display"
        ).textContent = `₹${totalProfit.toFixed(2)}`;

        // Also update split payment validation
        if (document.getElementById("splitPaymentToggle").checked) {
          updateSplitPaymentTotal();
        }
      }

      // Initialize when DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        // ... existing initialization code ...

        // Set default date for sale form to today
        document.getElementById("saleDate").value = formatDate(new Date());

        // Fetch payment methods
        fetchPaymentMethods();

        // Initialize split payment functionality
        initializeSplitPayment();

        // Set up initial active tabs
        document.querySelector(".nav-tab").classList.add("active");
        document.getElementById("sale-form").classList.add("active");
        updateDateDisplay();

        // Load initial data
        loadDashboard();

        fetchSalesSummary();

        // Fetch data
        async function fetchSalesSummary(
          dateStr = new Date().toISOString().split("T")[0],
          period = "daily"
        ) {
          try {
            const response = await fetch(
              `${API_URL}?type=sales&date=${dateStr}&period=${period}`,
              {
                method: "GET",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
              }
            );

            if (!response.ok) throw new Error("Failed to fetch sales summary");
            const data = await response.json();
            renderSalesSummary(data);
          } catch (error) {
            console.error(error);
          }
        }

        // Render data to DOM
        function renderSalesSummary(data) {
          document.getElementById("itemsSold").textContent =
            data.totalSales || 0;
          document.getElementById("salesAmount").textContent = `₹${
            data.totalRevenue || 0
          }`;
          document.getElementById("profitAmount").textContent = `₹${
            data.totalProfit || 0
          }`;
        }
      });
    </script>
  </body>
</html>
